class RigChat{constructor(t={}){this.config={apiBase:t.apiBase||"",theme:t.theme||"light",position:t.position||"right",welcomeMessage:t.welcomeMessage||"你好，我是AI Assistant，很高兴为您服务！",buttonIcon:t.buttonIcon||"ai",title:t.title||"AI Assistant",placeholder:t.placeholder||"Type your message...",containerId:t.containerId||"rig-chat-container",defaultWidth:t.defaultWidth||450,defaultHeight:t.defaultHeight||550},this.init()}async init(){console.log("Initializing Rig Chat component"),this.injectStyles(),this.loadFontAwesome(),await this.loadMarked();const t=localStorage.getItem("rig_chat_theme");t&&(this.config.theme=t);const e=localStorage.getItem("rig_chat_width");e&&(this.config.defaultWidth=parseInt(e));const o=localStorage.getItem("rig_chat_height");o&&(this.config.defaultHeight=parseInt(o)),this.createChatWidget(),this.initEventListeners(),await this.loadChatHistory(),this.applyDimensions(),console.log("Rig Chat component initialized")}injectStyles(){const t=document.createElement("style");t.textContent='#rig-chat-container *{box-sizing:border-box;font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;}.chat-container{height:calc(100vh - 180px);max-height:500px;}.chat-widget{transition:all 0.3s ease;transform-origin:bottom right;max-width:none !important;position:relative;min-width:300px;min-height:400px;overflow:hidden;}.chat-widget.collapsed{transform:scale(0);opacity:0;pointer-events:none;}.chat-widget.expanded{transition:all 0.3s ease;}.chat-button{box-shadow:0 4px 15px rgba(0, 0, 0, 0.15);transition:transform 0.2s;cursor:pointer;}.chat-button:hover{transform:scale(1.05);}.resize-handle{position:absolute;top:1px;left:1px;width:20px;height:20px;background-color:var(--bg-accent);opacity:0.5;z-index:999;cursor:nwse-resize;text-align:center;font-size:14px;color:white;}.resize-handle:hover{opacity:0.8;}.resize-handle::before{content:"⋮⋮";display:block;}.header-controls{display:flex;align-items:center;gap:8px;}.rig-header-title{margin-left:10px;}.rig-btn{background:none;border:none;color:var(--text-accent);opacity:0.8;cursor:pointer;padding:0;font-size:16px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:4px;}.rig-btn:hover{opacity:1;background-color:rgba(255, 255, 255, 0.1);}#rig-chat-header{display:flex;justify-content:space-between;align-items:center;background-color:var(--bg-accent);color:var(--text-accent);padding:12px 15px;border-top-left-radius:10px;border-top-right-radius:10px;}@keyframes slideIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}.message-animation{animation:slideIn 0.3s ease forwards;}.typing-indicator{display:inline-block;}.typing-indicator span{display:inline-block;width:5px;height:5px;background-color:currentColor;border-radius:50%;margin:0 1px;animation:bounce 1.2s infinite;}.typing-indicator span:nth-child(2){animation-delay:0.2s;}.typing-indicator span:nth-child(3){animation-delay:0.4s;}@keyframes bounce{0%, 60%, 100%{transform:translateY(0);}30%{transform:translateY(-4px);}}.custom-scrollbar::-webkit-scrollbar{width:6px;}.custom-scrollbar::-webkit-scrollbar-track{background:rgba(255, 255, 255, 0.5);border-radius:10px;}.custom-scrollbar::-webkit-scrollbar-thumb{background:rgba(0, 0, 0, 0.2);border-radius:10px;}.custom-scrollbar::-webkit-scrollbar-thumb:hover{background:rgba(0, 0, 0, 0.5);}.theme-dark .custom-scrollbar::-webkit-scrollbar-track{background:rgba(0, 0, 0, 0.5);}.theme-dark .custom-scrollbar::-webkit-scrollbar-thumb{background:rgba(255, 255, 255, 0.5);}.theme-dark .custom-scrollbar::-webkit-scrollbar-thumb:hover{background:rgba(255, 255, 255, 0.6);}.theme-light{--bg-primary:#ffffff;--bg-secondary:#f3f4f6;--bg-accent:#0ea5e9;--text-primary:#1f2937;--text-secondary:#6b7280;--text-accent:#ffffff;--border-color:#e5e7eb;--user-bubble:#0ea5e9;--bot-bubble:#e5e7eb;--user-text:#ffffff;--bot-text:#1f2937;}.theme-dark{--bg-primary:#1f2937;--bg-secondary:#111827;--bg-accent:#1e293b;--text-primary:#f9fafb;--text-secondary:#9ca3af;--text-accent:#ffffff;--border-color:#374151;--user-bubble:#3b82f6;--bot-bubble:#374151;--user-text:#ffffff;--bot-text:#e5e7eb;}#rig-chat-button{position:fixed;bottom:20px;width:46px;height:46px;border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:9999;color:var(--text-accent);background-color:var(--bg-accent);border:none;}#rig-chat-button.position-right{right:20px;}#rig-chat-button.position-left{left:20px;}#rig-chat-widget{position:fixed;bottom:80px;width:100%;max-width:450px;height:550px;border-radius:10px;overflow:hidden;background-color:var(--bg-primary);box-shadow:0 4px 25px rgba(0, 0, 0, 0.1);z-index:9998;display:flex;flex-direction:column;}#rig-chat-widget.position-right{right:20px;}#rig-chat-widget.position-left{left:20px;}#rig-chat-messages{flex:1;overflow-y:auto;padding:15px;background-color:var(--bg-secondary);display:flex;flex-direction:column;gap:10px;}#rig-chat-input-container{padding:10px 15px;border-top:1px solid var(--border-color);background-color:var(--bg-primary);position:relative;}#rig-chat-input{width:100%;padding:12px 40px 12px 12px;border-radius:8px;border:1px solid var(--border-color);background-color:var(--bg-secondary);color:var(--text-primary);outline:none;}#rig-chat-send{position:absolute;right:25px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--bg-accent);cursor:pointer;}.theme-dark #rig-chat-send{color:#3b82f6;}.rig-message-bubble{max-width:92%;padding:12px 15px;border-radius:10px;margin-bottom:8px;word-break:break-word;}.rig-user-message{align-self:flex-end;background-color:var(--user-bubble);color:var(--user-text);}.rig-bot-message{align-self:flex-start;background-color:var(--bot-bubble);color:var(--bot-text);width:96%;}.rig-bot-message code{font-family:monospace;background-color:rgba(0, 0, 0, 0.1);padding:2px 4px;border-radius:4px;font-size:0.9em;}.rig-bot-message pre{background-color:#282c34;color:#abb2bf;padding:12px;border-radius:6px;overflow-x:auto;margin:10px 0;}.rig-bot-message table{border-collapse:collapse;width:100%;margin:10px 0;border-radius:8px;overflow:hidden;box-shadow:0 2px 5px rgba(168, 168, 168, 0.05);table-layout:fixed;font-size:0.92em;border:1px solid rgba(255, 255, 255, 0.5);}.rig-bot-message th, .rig-bot-message td{border:1px solid rgba(255, 255, 255, 0.5);padding:8px 10px;text-align:center;overflow:visible;white-space:normal;word-wrap:break-word;}.rig-bot-message th{background-color:var(--bg-accent);color:var(--text-accent);font-weight:600;border-bottom:2px solid var(--border-color);position:relative;}.rig-bot-message tr:nth-child(even){background-color:rgba(0, 0, 0, 0.03);}.rig-bot-message tr:hover{background-color:rgba(0, 0, 0, 0.06);}.theme-dark .rig-bot-message th{background-color:var(--bg-accent);color:var(--text-accent);}.theme-dark .rig-bot-message tr:nth-child(even){background-color:rgba(255, 255, 255, 0.03);}.theme-dark .rig-bot-message tr:hover{background-color:rgba(255, 255, 255, 0.05);}.theme-dark .rig-bot-message table{border:1px solid rgba(180, 180, 180, 0.2);}.theme-dark .rig-bot-message th, .theme-dark .rig-bot-message td{border:1px solid rgba(180, 180, 180, 0.15);}.rig-bot-message ul, .rig-bot-message ol{margin:10px 0;padding-left:20px;}.rig-bot-message ul li{list-style-type:disc;}.rig-bot-message ol li{list-style-type:decimal;}',document.head.appendChild(t)}loadFontAwesome(){window.svgIcons={ai:'<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" color="currentColor"><path d="M14.17 20.89c4.184-.277 7.516-3.657 7.79-7.9c.053-.83.053-1.69 0-2.52c-.274-4.242-3.606-7.62-7.79-7.899a33 33 0 0 0-4.34 0c-4.184.278-7.516 3.657-7.79 7.9a20 20 0 0 0 0 2.52c.1 1.545.783 2.976 1.588 4.184c.467.845.159 1.9-.328 2.823c-.35.665-.526.997-.385 1.237c.14.24.455.248 1.084.263c1.245.03 2.084-.322 2.75-.813c.377-.279.566-.418.696-.434s.387.09.899.3c.46.19.995.307 1.485.34c1.425.094 2.914.094 4.342 0"/><path d="m7.5 15l1.842-5.526a.694.694 0 0 1 1.316 0L12.5 15m3-6v6m-7-2h3"/></g></svg>',robot:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M512 240c0 114.9-114.6 208-256 208c-37.1 0-72.3-6.4-104.1-17.9c-11.9 8.7-31.3 20.6-54.3 30.6C73.6 471.1 44.7 480 16 480c-6.5 0-12.3-3.9-14.8-9.9c-2.5-6-1.1-12.8 3.4-17.4l0 0 0 0 0 0 0 0 .3-.3c.3-.3 .7-.7 1.3-1.4c1.1-1.2 2.8-3.1 4.9-5.7c4.1-5 9.6-12.4 15.2-21.6c10-16.6 19.5-38.4 21.4-62.9C17.7 326.8 0 285.1 0 240C0 125.1 114.6 32 256 32s256 93.1 256 208z"/></svg>',times:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/></svg>',sun:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M361.5 1.2c5 2.1 8.6 6.6 9.6 11.9L391 121l107.9 19.8c5.3 1 9.8 4.6 11.9 9.6s1.5 10.7-1.6 15.2L446.9 256l62.3 90.3c3.1 4.5 3.7 10.2 1.6 15.2s-6.6 8.6-11.9 9.6L391 391 371.1 498.9c-1 5.3-4.6 9.8-9.6 11.9s-10.7 1.5-15.2-1.6L256 446.9l-90.3 62.3c-4.5 3.1-10.2 3.7-15.2 1.6s-8.6-6.6-9.6-11.9L121 391 13.1 371.1c-5.3-1-9.8-4.6-11.9-9.6s-1.5-10.7 1.6-15.2L65.1 256 2.8 165.7c-3.1-4.5-3.7-10.2-1.6-15.2s6.6-8.6 11.9-9.6L121 121 140.9 13.1c1-5.3 4.6-9.8 9.6-11.9s10.7-1.5 15.2 1.6L256 65.1 346.3 2.8c4.5-3.1 10.2-3.7 15.2-1.6zM160 256a96 96 0 1 1 192 0 96 96 0 1 1 -192 0zm224 0a128 128 0 1 0 -256 0 128 128 0 1 0 256 0z"/></svg>',moon:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M223.5 32C100 32 0 132.3 0 256S100 480 223.5 480c60.6 0 115.5-24.2 155.8-63.4c5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6c-96.9 0-175.5-78.8-175.5-176c0-65.8 36-123.1 89.3-153.3c6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z"/></svg>',"paper-plane":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480V396.4c0-4 1.5-7.8 4.2-10.7L331.8 202.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8 17.7 316.6C7.1 311.3 .3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z"/></svg>',expand:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M32 32C14.3 32 0 46.3 0 64v96c0 17.7 14.3 32 32 32s32-14.3 32-32V96h64c17.7 0 32-14.3 32-32s-14.3-32-32-32H32zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32v96c0 17.7 14.3 32 32 32h96c17.7 0 32-14.3 32-32s-14.3-32-32-32H64V352zM320 32c-17.7 0-32 14.3-32 32s14.3 32 32 32h64v64c0 17.7 14.3 32 32 32s32-14.3 32-32V64c0-17.7-14.3-32-32-32H320zM448 352c0-17.7-14.3-32-32-32s-32 14.3-32 32v64H320c-17.7 0-32 14.3-32 32s14.3 32 32 32h96c17.7 0 32-14.3 32-32V352z"/></svg>'}}loadMarked(){return new Promise(t=>{if(window.marked)return void t();const e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/marked",e.onload=()=>{console.log("Marked library loaded"),t()},e.onerror=e=>{console.error("Error loading Marked library:",e),t()},document.head.appendChild(e)})}createChatWidget(){const t=document.createElement("div");t.id=this.config.containerId,document.body.appendChild(t);const e=t=>window.svgIcons[t]||window.svgIcons.comment,o=e(this.config.buttonIcon);t.innerHTML=`<button id="rig-chat-button" class="chat-button" data-icon="${this.config.buttonIcon}"> ${o}</button><div id="rig-chat-widget" class="chat-widget collapsed" style="width:${this.config.defaultWidth}px;height:${this.config.defaultHeight}px;"><div id="rig-chat-header"><div class="rig-header-title">${this.config.title}</div><div class="header-controls"><button id="rig-theme-toggle" class="rig-btn" title="切换主题"> ${e("dark"===this.config.theme?"sun":"moon")}</button><button id="rig-minimize" class="rig-btn" title="关闭"> ${e("times")}</button></div></div><div class="resize-handle" id="rig-resize-handle" title="拖动调整大小"></div><div id="rig-chat-messages" class="custom-scrollbar"><div class="rig-message-bubble rig-bot-message message-animation"> ${this.config.welcomeMessage}</div></div><div id="rig-chat-input-container"><input id="rig-chat-input" type="text" placeholder="${this.config.placeholder}"><button id="rig-chat-send"> ${e("paper-plane")}</button></div></div>`;const i=document.getElementById("rig-chat-button"),a=document.getElementById("rig-chat-widget");i.classList.add(`position-${this.config.position}`,`theme-${this.config.theme}`),a.classList.add(`position-${this.config.position}`,`theme-${this.config.theme}`),document.documentElement.classList.add(`theme-${this.config.theme}`);const r=document.createElement("style");r.textContent='#rig-chat-button svg{width:24px;height:24px;fill:currentColor;}#rig-chat-button[data-icon="robot"] svg{width:32px;height:32px;}#rig-chat-widget button svg{width:16px;height:16px;fill:currentColor;}',document.head.appendChild(r)}initEventListeners(){const t=document.getElementById("rig-chat-widget"),e=document.getElementById("rig-chat-button"),o=document.getElementById("rig-minimize"),i=document.getElementById("rig-theme-toggle"),a=document.getElementById("rig-chat-input"),r=document.getElementById("rig-chat-send"),n=document.getElementById("rig-resize-handle");if(e.addEventListener("click",()=>{t.classList.toggle("collapsed");const o=t.classList.contains("collapsed")?this.config.buttonIcon:"times";e.setAttribute("data-icon",o),e.innerHTML=window.svgIcons[o]}),o.addEventListener("click",()=>{t.classList.add("collapsed"),e.setAttribute("data-icon",this.config.buttonIcon),e.innerHTML=window.svgIcons[this.config.buttonIcon]}),i.addEventListener("click",()=>{const o=t.classList.contains("theme-light"),a=o?"dark":"light";t.classList.remove("theme-"+(o?"light":"dark")),t.classList.add(`theme-${a}`),e.classList.remove("theme-"+(o?"light":"dark")),e.classList.add(`theme-${a}`),document.documentElement.classList.remove("theme-"+(o?"light":"dark")),document.documentElement.classList.add(`theme-${a}`),i.innerHTML=window.svgIcons[o?"sun":"moon"],this.config.theme=a,localStorage.setItem("rig_chat_theme",a)}),n){let e,o,i,a,r,s,c=!1,d="right"===this.config.position;n.addEventListener("mousedown",n=>{c=!0,e=n.clientX,o=n.clientY,i=t.offsetWidth,a=t.offsetHeight,r=t.getBoundingClientRect().top,s=t.getBoundingClientRect().left,document.addEventListener("mousemove",l),document.addEventListener("mouseup",g),n.preventDefault(),n.stopPropagation()});const l=r=>{if(!c)return;const n=r.clientX-e,s=r.clientY-o,l=window.innerWidth,g=window.innerHeight,h=t.getBoundingClientRect();let m,p;if(d){const e=l-10-(l-h.right);m=Math.min(e,Math.max(300,i-n));const o=g-10-(g-h.bottom);p=Math.min(o,Math.max(400,a-s)),t.style.right=t.style.right||"20px"}else{const e=l-10-h.left;m=Math.min(e,Math.max(300,i+n));const o=g-10-(g-h.bottom);p=Math.min(o,Math.max(400,a-s)),t.style.left=t.style.left||"20px"}t.style.width=`${m}px`,t.style.height=`${p}px`;const b=document.getElementById("rig-chat-messages");b&&(b.style.maxHeight=p-100+"px"),this.config.defaultWidth=m,this.config.defaultHeight=p,localStorage.setItem("rig_chat_width",m.toString()),localStorage.setItem("rig_chat_height",p.toString()),t.classList.toggle("expanded",m>450||p>550),r.preventDefault()},g=()=>{c=!1,document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",g)}}a.addEventListener("keypress",t=>{"Enter"===t.key&&this.sendMessage()}),r.addEventListener("click",this.sendMessage.bind(this))}applyDimensions(){const t=document.getElementById("rig-chat-widget");if(!t)return;const e=this.config.defaultWidth,o=this.config.defaultHeight;t.style.width=`${e}px`,t.style.height=`${o}px`,t.classList.toggle("expanded",e>450||o>550);const i=document.getElementById("rig-chat-messages");i&&(i.style.maxHeight=o-100+"px")}async sendMessage(){const t=document.getElementById("rig-chat-input"),e=t.value.trim();if(!e)return;this.addMessage(e,!0),t.value="";const o=this.addLoadingIndicator();try{let t=localStorage.getItem("rig_chat_user_id");const i=`${this.config.apiBase}/api/chat`,a=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e,user_id:t})}),r=await a.json();!t&&r.user_id&&(t=r.user_id,localStorage.setItem("rig_chat_user_id",t)),this.removeLoadingIndicator(o),this.addMessage(r.response,!1)}catch(t){console.error("Error:",t),this.removeLoadingIndicator(o),this.addMessage("Sorry, there was an error processing your message.",!1)}}addMessage(t,e){const o=document.getElementById("rig-chat-messages"),i=document.createElement("div");if(i.className=`rig-message-bubble ${e?"rig-user-message":"rig-bot-message"} message-animation`,!e&&window.marked){if(/([*_~`]|#{1,6}|\[[^\]]+\]\([^)]+\)|```|\|[-|]|>|^\d+\.|^\s*[-*+])/.test(t)){t=t.replace(/(\n|^)(\|[^\n]+\|)(\n|$)/g,"\n$2\n");try{i.innerHTML=marked.parse(t)}catch(e){console.error("Markdown parsing error:",e),i.textContent=t}}else i.textContent=t}else i.textContent=t;o.appendChild(i),o.scrollTop=o.scrollHeight}addLoadingIndicator(){const t=document.getElementById("rig-chat-messages"),e=document.createElement("div");e.className="rig-message-bubble rig-bot-message message-animation",e.id="rig-loading-"+Date.now();const o=document.createElement("div");return o.className="typing-indicator",o.innerHTML="<span></span><span></span><span></span>",e.appendChild(o),t.appendChild(e),t.scrollTop=t.scrollHeight,e.id}removeLoadingIndicator(t){const e=document.getElementById(t);e&&e.remove()}async loadChatHistory(){const t=localStorage.getItem("rig_chat_user_id");if(t)try{const e=`${this.config.apiBase}/api/history/${t}`,o=await fetch(e),i=await o.json();if(i.length>0){document.getElementById("rig-chat-messages").innerHTML="";for(const t of i)this.addMessage(t.content,"user"===t.role)}}catch(t){console.error("Error loading chat history:",t)}}}"undefined"!=typeof module&&module.exports?module.exports=RigChat:window.RigChat=RigChat;