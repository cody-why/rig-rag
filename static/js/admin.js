const API_BASE="";let authToken=localStorage.getItem("authToken"),currentUserRole=null,currentDocumentId=null,currentPage=0,pageSize=10,totalDocuments=0;function getAuthHeaders(){return{"Content-Type":"application/json",Authorization:`Bearer ${authToken}`}}async function checkAuth(){if(!authToken)return window.location.href="/login",!1;try{const e=await fetch("/api/auth/verify",{method:"POST",headers:getAuthHeaders()});if(!e.ok)throw new Error("Token invalid");const t=await e.json();currentUserRole=t.role,localStorage.setItem("userRole",t.role);const o=document.getElementById("userInfo");return o&&(o.textContent=`👤 ${t.sub} (${t.role})`),updateUIPermissions(),!0}catch(e){return console.error("Auth check failed:",e),localStorage.removeItem("authToken"),localStorage.removeItem("username"),localStorage.removeItem("userRole"),window.location.href="/login",!1}}function hasSpecialAccess(){return new URLSearchParams(window.location.search).has("cody")}function updateUIPermissions(){const e="admin"===currentUserRole,t=hasSpecialAccess(),o=document.querySelector('.nav-item[onclick*="preamble"]'),n=document.querySelector('.nav-item[onclick*="users"]');o&&(o.style.display=t?"block":"none"),n&&(n.style.display=e?"block":"none")}function logout(){localStorage.removeItem("authToken"),localStorage.removeItem("username"),localStorage.removeItem("userRole"),window.location.href="/login"}function showSection(e){const t="admin"===currentUserRole,o=hasSpecialAccess();if("preamble"===e&&!t&&!o)return void showAlert("您没有权限访问此功能","error");if("users"===e&&!t)return void showAlert("您没有权限访问此功能","error");document.querySelectorAll(".section").forEach(e=>{e.classList.remove("active")}),document.querySelectorAll(".nav-item").forEach(e=>{e.classList.remove("active")}),document.getElementById(e).classList.add("active");document.querySelectorAll(".nav-item").forEach(t=>{const o=t.getAttribute("onclick");o&&o.includes(`'${e}'`)&&t.classList.add("active")});const n=new URL(window.location.href).search;switch(n?history.replaceState(null,null,`${n}#${e}`):history.replaceState(null,null,`#${e}`),e){case"documents":loadDocuments();break;case"preamble":loadPreamble();break;case"upload":document.getElementById("createDocumentForm").reset();break;case"users":loadUsers();break}}function loadSectionFromHash(){let e=window.location.hash.substring(1);e&&["documents","preamble","upload","users"].includes(e)?showSection(e):showSection("documents")}function showAlert(e,t="success"){const o=document.getElementById("alertContainer"),n=document.createElement("div");n.className="alert alert-"+("error"===t?"error":"success"),n.textContent=e,o.appendChild(n),setTimeout(()=>{n.remove()},3e3)}function showSecretKeyModal(e){const t=document.createElement("div");t.className="modal-backdrop",t.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000",t.innerHTML='<div class="modal-content" style="background:white;padding:30px;border-radius:15px;width:90%;max-width:400px;"><h3 style="margin-bottom:20px;">🔑 验证</h3><form id="secretKeyForm"><div class="form-group"><input type="password" id="secretKeyInput" class="form-control" placeholder="请输入密钥" required autofocus></div><div><button type="submit" class="btn btn-primary">✅ 确认</button><button type="button" class="btn btn-secondary modal-cancel-btn">❌ 取消</button></div></form></div>';t.querySelector(".modal-cancel-btn").addEventListener("click",()=>t.remove()),t.addEventListener("click",e=>{e.target===t&&t.remove()}),t.querySelector(".modal-content").addEventListener("click",e=>{e.stopPropagation()}),t.querySelector("#secretKeyForm").addEventListener("submit",o=>{o.preventDefault();const n=document.getElementById("secretKeyInput").value.trim();t.remove(),e(n)}),document.body.appendChild(t),setTimeout(()=>{document.getElementById("secretKeyInput").focus()},100)}async function loadDocuments(e=0){const t=document.getElementById("documentsLoading"),o=document.getElementById("documentsList"),n=document.getElementById("pagination");t.style.display="block",o.innerHTML="",n.style.display="none";try{const n=e*pageSize,r=await fetch(`/api/documents?limit=${pageSize}&offset=${n}`,{headers:getAuthHeaders()});if(!r.ok)throw new Error("获取文档列表失败");const a=await r.json();if(t.style.display="none",currentPage=e,totalDocuments=a.total,0===a.documents.length)return void(o.innerHTML='<p style="text-align: center; color: #6c757d; padding: 40px;">暂无文档，请先上传一些文档。</p>');a.documents.forEach(e=>{const t=createDocumentElement(e);o.appendChild(t)}),updatePaginationControls()}catch(e){t.style.display="none",showAlert(e.message,"error"),o.innerHTML='<p style="text-align: center; color: #dc3545; padding: 40px;">加载文档失败，请检查网络连接。</p>'}}function createDocumentElement(e){const t=document.createElement("div");t.className="document-item";const o=new Date(e.created_at).toLocaleString("zh-CN"),n=new Date(e.updated_at).toLocaleString("zh-CN");return t.innerHTML=`<h3>${escapeHtml(e.filename)}</h3><div class="document-meta"> 📅 创建时间: ${o} | 🔄 更新时间: ${n} </div><p>${escapeHtml(e.preview)}</p><div class="document-actions"><button class="btn btn-primary" onclick="editDocument('${e.id}')">✏️ 编辑</button><button class="btn btn-secondary" onclick="viewDocument('${e.id}')">👁️ 查看</button><button class="btn btn-danger" onclick="deleteDocument('${e.id}', '${escapeHtml(e.filename)}')">🗑️ 删除</button></div>`,t}function updatePaginationControls(){const e=document.getElementById("pagination"),t=document.getElementById("prevPage"),o=document.getElementById("nextPage"),n=document.getElementById("pageInfo");if(totalDocuments<=pageSize)return void(e.style.display="none");e.style.display="block";const r=Math.ceil(totalDocuments/pageSize),a=currentPage+1;n.textContent=`第 ${a} 页，共 ${r} 页 (${totalDocuments} 个文档)`,t.disabled=0===currentPage,o.disabled=currentPage>=r-1}function goToPreviousPage(){currentPage>0&&loadDocuments(currentPage-1)}function goToNextPage(){const e=Math.ceil(totalDocuments/pageSize);currentPage<e-1&&loadDocuments(currentPage+1)}async function editDocument(e){try{const t=await fetch(`/api/documents/${e}`,{headers:getAuthHeaders()});if(!t.ok)throw new Error("获取文档详情失败");const o=createEditModal(await t.json());document.body.appendChild(o)}catch(e){showAlert(e.message,"error")}}function createEditModal(e){const t=document.createElement("div");t.className="modal-backdrop",t.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000",t.innerHTML=`<div class="modal-content" style="background:white;padding:30px;border-radius:15px;width:90%;max-width:800px;max-height:85%;overflow-y:auto;position:relative;"><button class="floating-close-btn" style="position:absolute;top:10px;right:10px;background:rgba(0, 0, 0, 0.7);color:white;border:none;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:1001;opacity:0.8;transition:opacity 0.3s ease;" title="关闭"> ❌ </button><h3 style="margin-bottom:20px;">✏️ 编辑文档</h3><form id="editDocumentForm"><div class="form-group"><label>文件名：</label><input type="text" id="editFilename" class="form-control" value="${escapeHtml(e.filename)}" required></div><div class="form-group"><label>文档内容：</label><textarea id="editContent" class="form-control" rows="22" required>${escapeHtml(e.content)}</textarea></div><div><button type="submit" class="btn btn-primary">💾 保存</button><button type="button" class="btn btn-secondary modal-cancel-btn">❌ 取消</button></div></form></div>`;t.querySelector(".modal-cancel-btn").addEventListener("click",()=>t.remove());return t.querySelector(".floating-close-btn").addEventListener("click",()=>t.remove()),t.addEventListener("click",e=>{e.target===t&&t.remove()}),t.querySelector(".modal-content").addEventListener("click",e=>{e.stopPropagation()}),t.querySelector("#editDocumentForm").addEventListener("submit",async o=>{o.preventDefault();const n=document.getElementById("editFilename").value.trim(),r=document.getElementById("editContent").value.trim();if(n&&r)try{if(!(await fetch(`/api/documents/${e.id}`,{method:"PUT",headers:getAuthHeaders(),body:JSON.stringify({filename:n,content:r})})).ok)throw new Error("更新文档失败");showAlert("文档更新成功！"),t.remove(),loadDocuments()}catch(e){showAlert(e.message,"error")}else showAlert("请填写完整信息","error")}),t}async function viewDocument(e){try{const t=await fetch(`/api/documents/${e}`,{headers:getAuthHeaders()});if(!t.ok)throw new Error("获取文档详情失败");const o=await t.json(),n=document.createElement("div");n.className="modal-backdrop",n.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000";const r=new Date(o.created_at).toLocaleString("zh-CN"),a=new Date(o.updated_at).toLocaleString("zh-CN");n.innerHTML=`<div class="modal-content" style="background:white;padding:30px;border-radius:15px;width:90%;max-width:800px;max-height:80%;overflow:hidden;position:relative;display:flex;flex-direction:column;"><button class="floating-close-btn" style="position:absolute;top:10px;right:10px;background:rgba(0, 0, 0, 0.7);color:white;border:none;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:1001;opacity:0.8;transition:opacity 0.3s ease;" title="关闭"> ❌ </button><h3 style="margin-bottom:20px;">👁️ ${escapeHtml(o.filename)}</h3><div style="margin-bottom:20px;color:#6c757d;font-size:0.9rem;"> 📅 创建时间:${r}<br> 🔄 更新时间:${a}</div><div style="flex:1;overflow-y:auto;margin:0 -10px;padding:0 10px;"><div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:20px;white-space:pre-wrap;font-family:monospace;font-size:1rem;">${escapeHtml(o.content)}</div></div></div>`;n.querySelector(".floating-close-btn").addEventListener("click",()=>n.remove()),n.addEventListener("click",e=>{e.target===n&&n.remove()}),n.querySelector(".modal-content").addEventListener("click",e=>{e.stopPropagation()}),document.body.appendChild(n)}catch(e){showAlert(e.message,"error")}}async function deleteDocument(e,t){if(confirm(`确定要删除文档 "${t}" 吗？此操作不可恢复。`))try{if(!(await fetch(`/api/documents/${e}`,{method:"DELETE",headers:getAuthHeaders()})).ok)throw new Error("删除文档失败");showAlert("文档删除成功！"),loadDocuments()}catch(e){showAlert(e.message,"error")}}async function resetDocuments(){if(confirm("⚠️ 确定要重置文档存储吗？\n\n这将删除所有文档和向量索引，此操作不可恢复！\n\n建议在schema更改或数据损坏时使用。")&&confirm("🚨 最后确认：这将永久删除所有文档数据！\n\n确定要继续吗？"))try{if(!(await fetch("/api/documents/reset",{method:"POST",headers:getAuthHeaders()})).ok)throw new Error("重置文档存储失败");showAlert("✅ 文档存储重置成功！请重新上传文档。","success"),loadDocuments()}catch(e){showAlert(e.message,"error")}}async function loadPreamble(){const e=document.getElementById("preambleLoading"),t=document.getElementById("preambleForm");e.style.display="block",t.style.display="none";try{const o=await fetch("/api/preamble",{headers:getAuthHeaders()});if(!o.ok)throw new Error("获取Preamble配置失败");const n=await o.json();document.getElementById("preambleContent").value=n.content,e.style.display="none",t.style.display="block"}catch(t){e.style.display="none",showAlert(t.message,"error")}}function validateFileType(e){const t="."+e.name.split(".").pop().toLowerCase();return!![".txt",".md",".json",".csv",".pdf",".docx",".xlsx"].includes(t)||(showAlert("不支持的文件类型，请选择 .txt, .md, .json, .csv, .pdf, .docx, .xlsx 文件","error"),!1)}function handleFileSelect(e){const t=e.target.files[0];t&&validateFileType(t)&&uploadDocument(t)}async function uploadDocument(e){try{const t=new FormData;t.append("filename",e.name),t.append("file",e);const o={Authorization:`Bearer ${authToken}`};if(!(await fetch("/api/documents/upload",{method:"POST",headers:o,body:t})).ok)throw new Error("上传文档失败");showAlert("文档上传成功！"),document.getElementById("fileInput").value="",document.getElementById("documents").classList.contains("active")&&loadDocuments()}catch(e){showAlert(e.message,"error")}}function escapeHtml(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,e=>t[e])}function setupFileDragAndDrop(){const e=document.querySelector(".file-upload");function t(e){e.preventDefault(),e.stopPropagation()}function o(){e.style.background="#f8f9ff",e.style.borderColor="#667eea",e.style.transform="scale(1.02)"}function n(){e.style.background="",e.style.borderColor="",e.style.transform=""}e&&(["dragenter","dragover","dragleave","drop"].forEach(o=>{e.addEventListener(o,t,!1),document.body.addEventListener(o,t,!1)}),["dragenter","dragover"].forEach(t=>{e.addEventListener(t,o,!1)}),["dragleave","drop"].forEach(t=>{e.addEventListener(t,n,!1)}),e.addEventListener("drop",function(e){const t=e.dataTransfer.files;t.length>0&&function(e){const t=e[0];if(!validateFileType(t))return;uploadDocument(t)}(t)},!1))}async function loadUsers(){const e=document.getElementById("usersLoading"),t=document.getElementById("usersList");e.style.display="block",t.innerHTML="";try{const o=await fetch("/api/users",{headers:getAuthHeaders()});if(!o.ok)throw new Error("获取用户列表失败");const n=await o.json();if(e.style.display="none",0===n.length)return void(t.innerHTML='<p style="text-align: center; color: #6c757d; padding: 40px;">暂无用户。</p>');const r=document.createElement("div");r.style.cssText="background: #f8f9fa; border-radius: 10px; overflow: hidden;",r.innerHTML='<table style="width:100%;border-collapse:collapse;"><thead><tr style="background:#667eea;color:white;"><th style="padding:15px;text-align:left;">用户名</th><th style="padding:15px;text-align:left;">角色</th><th style="padding:15px;text-align:left;">状态</th><th style="padding:15px;text-align:left;">创建时间</th><th style="padding:15px;text-align:center;">操作</th></tr></thead><tbody id="usersTableBody"></tbody></table>',t.appendChild(r);const a=document.getElementById("usersTableBody");n.forEach((e,t)=>{const o=document.createElement("tr");o.style.cssText=`background:${t%2==0?"white":"#f8f9fa"};border-bottom:1px solid #e9ecef`;const n=new Date(e.created_at).toLocaleString("zh-CN"),r="admin"===e.role?"👑 管理员":"👤 用户",s=1===e.status?'<span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">✅ 启用</span>':'<span style="background: #dc3545; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">❌ 禁用</span>';o.innerHTML=`<td style="padding:15px;font-weight:600;">${escapeHtml(e.username)}</td><td style="padding:15px;">${r}</td><td style="padding:15px;">${s}</td><td style="padding:15px;color:#6c757d;font-size:0.9rem;">${n}</td><td style="padding:15px;text-align:center;"><button class="btn btn-primary" onclick="editUser(${e.id})" style="padding:6px 12px;font-size:0.85rem;margin-right:5px;"> ✏️ 编辑 </button><button class="btn btn-danger" onclick="deleteUser(${e.id}, '${escapeHtml(e.username)}')" style="padding:6px 12px;font-size:0.85rem;"> 🗑️ 删除 </button></td>`,a.appendChild(o)})}catch(o){e.style.display="none",showAlert(o.message,"error"),t.innerHTML='<p style="text-align: center; color: #dc3545; padding: 40px;">加载用户失败。</p>'}}function showCreateUserModal(){const e=document.createElement("div");e.className="modal-backdrop",e.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000",e.innerHTML='<div class="modal-content" style="background:white;padding:30px;border-radius:15px;width:90%;max-width:500px;"><h3 style="margin-bottom:20px;">➕ 创建新用户</h3><form id="createUserForm"><div class="form-group"><label>用户名：</label><input type="text" id="newUsername" class="form-control" placeholder="请输入用户名" required></div><div class="form-group"><label>密码：</label><input type="password" id="newPassword" class="form-control" placeholder="请输入密码" required></div><div class="form-group"><label>角色：</label><select id="newRole" class="form-control"><option value="user">👤 普通用户</option><option value="admin">👑 管理员</option></select></div><div class="form-group"><label>状态：</label><select id="newStatus" class="form-control"><option value="1" selected>✅ 启用</option><option value="0">❌ 禁用</option></select></div><div><button type="submit" class="btn btn-primary">💾 创建</button><button type="button" class="btn btn-secondary modal-cancel-btn">❌ 取消</button></div></form></div>',e.querySelector(".modal-cancel-btn").addEventListener("click",()=>e.remove()),e.addEventListener("click",t=>{t.target===e&&e.remove()}),e.querySelector("#createUserForm").addEventListener("submit",async t=>{t.preventDefault();const o=document.getElementById("newUsername").value.trim(),n=document.getElementById("newPassword").value,r=document.getElementById("newRole").value,a=parseInt(document.getElementById("newStatus").value);if(o&&n)try{const t=await fetch("/api/users",{method:"POST",headers:getAuthHeaders(),body:JSON.stringify({username:o,password:n,role:r,status:a})});if(!t.ok){const e=await t.json();throw new Error(e.error||"创建用户失败")}showAlert("用户创建成功！"),e.remove(),loadUsers()}catch(e){showAlert(e.message,"error")}else showAlert("请填写完整信息","error")}),document.body.appendChild(e)}async function editUser(e){try{const t=await fetch(`/api/users/${e}`,{headers:getAuthHeaders()});if(!t.ok)throw new Error("获取用户信息失败");const o=await t.json(),n=document.createElement("div");n.className="modal-backdrop",n.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000",n.innerHTML=`<div class="modal-content" style="background:white;padding:30px;border-radius:15px;width:90%;max-width:500px;"><h3 style="margin-bottom:20px;">✏️ 编辑用户:${escapeHtml(o.username)}</h3><form id="editUserForm"><div class="form-group"><label>新密码（留空则不修改）：</label><input type="password" id="editPassword" class="form-control" placeholder="请输入新密码"></div><div class="form-group"><label>角色：</label><select id="editRole" class="form-control"><option value="user" ${"user"===o.role?"selected":""}>👤 普通用户</option><option value="admin" ${"admin"===o.role?"selected":""}>👑 管理员</option></select></div><div class="form-group"><label>状态：</label><select id="editStatus" class="form-control"><option value="1" ${1===o.status?"selected":""}>✅ 启用</option><option value="0" ${0===o.status?"selected":""}>❌ 禁用</option></select></div><div><button type="submit" class="btn btn-primary">💾 保存</button><button type="button" class="btn btn-secondary modal-cancel-btn">❌ 取消</button></div></form></div>`,n.querySelector(".modal-cancel-btn").addEventListener("click",()=>n.remove()),n.addEventListener("click",e=>{e.target===n&&n.remove()}),n.querySelector("#editUserForm").addEventListener("submit",async t=>{t.preventDefault();const r=document.getElementById("editPassword").value.trim(),a=document.getElementById("editRole").value,s=parseInt(document.getElementById("editStatus").value),c={};if(r&&(c.password=r),a!==o.role&&(c.role=a),s!==o.status&&(c.status=s),0!==Object.keys(c).length)try{const t=await fetch(`/api/users/${e}`,{method:"PUT",headers:getAuthHeaders(),body:JSON.stringify(c)});if(!t.ok){const e=await t.json();throw new Error(e.error||"更新用户失败")}showAlert("用户更新成功！"),n.remove(),loadUsers()}catch(e){showAlert(e.message,"error")}else showAlert("没有需要更新的内容","error")}),document.body.appendChild(n)}catch(e){showAlert(e.message,"error")}}async function deleteUser(e,t){if(confirm(`确定要删除用户 "${t}" 吗？此操作不可恢复。`))try{const t=await fetch(`/api/users/${e}`,{method:"DELETE",headers:getAuthHeaders()});if(!t.ok){const e=await t.json();throw new Error(e.error||"删除用户失败")}showAlert("用户删除成功！"),loadUsers()}catch(e){showAlert(e.message,"error")}}document.addEventListener("DOMContentLoaded",async function(){await checkAuth()&&(document.getElementById("preambleForm").addEventListener("submit",async function(e){e.preventDefault();const t=document.getElementById("preambleContent").value.trim();t?showSecretKeyModal(async e=>{if(e)try{const o=await fetch("/api/preamble",{method:"PUT",headers:getAuthHeaders(),body:JSON.stringify({content:t,secret_key:e})});if(403===o.status)return void showAlert("❌ 验证失败，无权限保存配置","error");if(!o.ok)throw new Error("保存Preamble配置失败");showAlert("✅ Preamble配置保存成功！")}catch(e){showAlert(e.message,"error")}else showAlert("请输入验证密钥","error")}):showAlert("请输入Preamble内容","error")}),document.getElementById("createDocumentForm").addEventListener("submit",async function(e){e.preventDefault();const t=document.getElementById("documentFilename").value.trim(),o=document.getElementById("documentContent").value.trim();if(t&&o)try{if(!(await fetch("/api/documents",{method:"POST",headers:getAuthHeaders(),body:JSON.stringify({filename:t,content:o})})).ok)throw new Error("创建文档失败");showAlert("文档创建成功！"),this.reset()}catch(e){showAlert(e.message,"error")}else showAlert("请填写完整信息","error")}),document.getElementById("prevPage").addEventListener("click",goToPreviousPage),document.getElementById("nextPage").addEventListener("click",goToNextPage),setupFileDragAndDrop(),window.addEventListener("hashchange",loadSectionFromHash),loadSectionFromHash())});